# 灾难恢复计划

## 概述

本文档定义CSIC平台的灾难恢复策略，包括备份策略、恢复流程和业务连续性保障。

## 恢复目标

### 恢复点目标 (RPO)

| 数据类型 | RPO | 说明 |
|----------|-----|------|
| 交易数据 | 1小时 | 可接受1小时数据丢失 |
| 审计日志 | 0 | 不可丢失 |
| 系统配置 | 24小时 | 可接受24小时配置变更丢失 |
| 用户数据 | 1小时 | 可接受1小时数据丢失 |

### 恢复时间目标 (RTO)

| 系统组件 | RTO | 说明 |
|----------|-----|------|
| 核心控制层 | 4小时 | 关键监管功能 |
| 交易所监管 | 4小时 | 市场监控功能 |
| 区块链分析 | 8小时 | 分析功能 |
| 报告系统 | 24小时 | 非关键功能 |

## 备份策略

### 备份类型

| 备份类型 | 频率 | 保留时间 | 存储位置 |
|----------|------|----------|----------|
| 全量备份 | 每日 | 30天 | 本地 + 异地 |
| 增量备份 | 每小时 | 7天 | 本地 |
| 事务日志 | 实时 | 7天 | 本地 + 异地 |
| 配置备份 | 变更时 | 90天 | 本地 |

### 备份时间表

```bash
# 每日全量备份 - 02:00
0 2 * * * /scripts/backup/full-backup.sh

# 每小时增量备份 - 每小时整点
0 * * * * /scripts/backup/incremental-backup.sh

# 实时事务日志备份 - 通过复制
* * * * * /scripts/backup/log-shipping.sh

# 配置变更备份 - 通过webhook
# 在配置变更时自动触发
```

### 备份验证

```bash
# 验证备份完整性
./scripts/backup/verify-backup.sh --backup <backup_id>

# 测试恢复流程
./scripts/backup/test-restore.sh --env test

# 生成备份报告
./scripts/backup/report.sh --period daily
```

## 灾难恢复场景

### 场景1: 数据库故障

**检测**:
- 数据库连接失败告警
- 健康检查失败

**响应**:
1. 确认故障
2. 评估影响范围
3. 启动故障转移

**恢复步骤**:
```bash
# 1. 检查主库状态
./scripts/monitoring/check-db.sh --primary

# 2. 触发故障转移
./scripts/failover/trigger-failover.sh --type database

# 3. 验证从库状态
./scripts/monitoring/check-db.sh --secondary

# 4. 更新连接配置
./scripts/config/update-db-endpoint.sh

# 5. 验证应用连接
./scripts/monitoring/verify-app-db.sh
```

### 场景2: 整个数据中心故障

**检测**:
- 多个系统告警
- 网络不可达
- 基础设施故障

**响应**:
1. 确认灾难状态
2. 通知相关方
3. 启动灾难恢复

**恢复步骤**:
```bash
# 1. 激活异地灾备站点
./scripts/dr/activate-standby.sh --target disaster-recovery

# 2. 从备份恢复数据库
./scripts/restore/restore-db.sh \
  --backup latest \
  --target dr-site \
  --type full

# 3. 恢复配置
./scripts/restore/restore-config.sh \
  --env production-dr

# 4. 启动服务
./scripts/deploy/start-services.sh \
  --site disaster-recovery \
  --services all

# 5. 验证系统
./scripts/monitoring/full-health-check.sh
```

### 场景3: 数据损坏

**检测**:
- 数据完整性检查失败
- 应用错误
- 用户报告

**响应**:
1. 隔离受影响系统
2. 评估损坏范围
3. 制定恢复计划

**恢复步骤**:
```bash
# 1. 识别损坏数据
./scripts/diagnostics/check-data-integrity.sh

# 2. 停止写入操作
./scripts/maintenance/set-readonly.sh

# 3. 恢复到上一个有效点
./scripts/restore/point-in-time-recovery.sh \
  --timestamp <last-valid-time>

# 4. 验证数据完整性
./scripts/diagnostics/verify-data.sh

# 5. 恢复写入操作
./scripts/maintenance/set-writable.sh
```

## 灾备站点架构

### 异地灾备站点

```
主站点 (Site A)                          灾备站点 (Site B)
┌────────────────────┐                 ┌────────────────────┐
│  PostgreSQL主库     │  ──同步复制──>  │  PostgreSQL从库     │
│  (读写)             │                 │  (热备)             │
└────────────────────┘                 └────────────────────┘
         │                                     │
         │ 异步复制                            │
         ▼                                     ▼
┌────────────────────┐                 ┌────────────────────┐
│  应用服务器         │                 │  应用服务器         │
│  (全部服务)         │                 │  (备用)             │
└────────────────────┘                 └────────────────────┘
         │                                     │
         └─────────────┬───────────────────────┘
                       │
                       ▼
              ┌────────────────────┐
              │  负载均衡器         │
              │  (主站点优先)       │
              └────────────────────┘
```

### 切换机制

| 条件 | 动作 | 自动化 |
|------|------|--------|
| 主库不可达 | 自动切换到从库 | 是 |
| 主站点网络不可达 | 手动切换到灾备站点 | 否 |
| 数据损坏 | 恢复到上一个检查点 | 是 |
| 整个数据中心故障 | 启动灾备站点 | 手动确认 |

## 恢复验证

### 定期演练

| 演练类型 | 频率 | 参与人员 | 验证内容 |
|----------|------|----------|----------|
| 桌面演练 | 每月 | 响应团队 | 流程熟悉 |
| 模拟恢复 | 季度 | 运维团队 | 恢复步骤 |
| 完整演练 | 每年 | 所有相关方 | 端到端恢复 |

### 演练报告

```markdown
## 演练报告 - [日期]

### 演练概述
- 演练类型: [类型]
- 参与人员: [列表]
- 持续时间: [时长]

### 演练结果
- RTO达成: [是/否] - 实际时间 [时间]
- RPO达成: [是/否] - 实际丢失 [时间]
- 发现问题: [列表]
- 改进建议: [列表]

### 后续行动
- [行动项 1]
- [行动项 2]
```

## 外部依赖恢复

### 云服务依赖

| 服务 | 替代方案 | 恢复时间 |
|------|----------|----------|
| DNS | 本地hosts配置 | 5分钟 |
| CDN | 直接访问源站 | 10分钟 |
| 监控 | 本地监控 | 15分钟 |

### 第三方依赖

| 服务 | SLA | 替代方案 |
|------|-----|----------|
| 区块链节点 | 99.9% | 备用节点 |
| 短信服务 | 99.9% | 邮件通知 |
| 邮件服务 | 99.9% | 备用SMTP |
