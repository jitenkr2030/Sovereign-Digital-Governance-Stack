name: CI Pipeline

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - 'docs/**'
      - '**.md'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment for testing'
        required: false
        default: 'development'

env:
  REGISTRY: registry.example.com
  IMAGE_NAME: neam-platform/${{ github.repository }}
  GOLANG_VERSION: '1.21'

jobs:
  lint:
    name: Lint and Security
    runs-on: ubuntu-latest
    outputs:
      passed: ${{ steps.lint.result }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GOLANG_VERSION }}
          cache: true

      - name: Install go linters
        id: lint
        run: |
          # Install golangci-lint
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.55.2
          
          # Run linter
          $(go env GOPATH)/bin/golangci-lint run --timeout 10m ./...

      - name: Run YAML lint
        if: always()
        run: |
          pip install --quiet yamllint
          yamllint -c .yamllint.yaml .

      - name: Check Kubernetes manifests
        if: always()
        run: |
          # Install kubeval or checkov
          pip install --quiet checkov
          checkov -d . --framework kubernetes --skip-check CKV_K8S_3,CKV_K8S_20

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: |
            gl-*.json
          retention-days: 7

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    if: needs.lint.outputs.passed == 'success'
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        ports:
          - 5432/tcp
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379/tcp
        options: >-
          --health-cmd redis-cli ping
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GOLANG_VERSION }}
          cache: true

      - name: Run database migrations
        run: |
          # Apply test migrations
          migrate -path migrations -database "postgres://test:test@localhost:5432/test?sslmode=disable" up

      - name: Run unit tests
        run: |
          go test -v -race -cover -coverprofile=coverage.txt -covermode=atomic ./...
        env:
          DATABASE_URL: postgres://test:test@localhost:5432/test?sslmode=disable
          REDIS_URL: redis://localhost:6379/0
          TEST_ENV: ci

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.txt
          retention-days: 7

      - name: Add coverage comment to PR
        if: github.event_name == 'pull_request'
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.txt
          fail_ci_if_error: false

  build:
    name: Build and Scan
    runs-on: ubuntu-latest
    needs: test
    if: needs.test.result == 'success'
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable={{is_default_branch}}
            type=semver,pattern={{version}}

      - name: Log in to registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build and push
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ github.ref }}
          cache-to: type=gha,mode=max,scope=${{ github.ref }}
          build-args: |
            VERSION=${{ github.sha }}
            BUILD_DATE=${{ env.BUILD_DATE }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: sarif
          output: trivy-results.sarif

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: trivy-results.sarif
        if: always()

      - name: Run container SBOM generation
        uses: anchore/sbom-action@v0.15.0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          output-file: sbom.json
          upload-artifact: true

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json
          retention-days: 30

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kind cluster
        uses: helm/kind-action@v1.8.0
        with:
          cluster-name: test-${{ github.run_id }}
          version: v0.20.0

      - name: Install application
        run: |
          # Install application in test cluster
          kubectl create namespace test
          helm upgrade --install test-app ./chart --namespace test \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set image.tag=${{ github.sha }}

      - name: Wait for deployment
        run: |
          kubectl wait --for=condition=available --timeout=300s deployment/test-app -n test

      - name: Run integration tests
        run: |
          kubectl run test --rm -i --restart=Never --image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} -- ./test-integration.sh
        continue-on-error: true

      - name: Collect logs on failure
        if: failure()
        run: |
          kubectl logs -l app=test-app -n test --tail=100 > integration-logs.txt
          cat integration-logs.txt

      - name: Cleanup
        if: always()
        run: |
          helm uninstall test-app -n test
          kind delete cluster --name test-${{ github.run_id }}

  validate-manifests:
    name: Validate Manifests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout manifests
        uses: actions/checkout@v4
        with:
          repository: neam-platform/manifests
          path: manifests
          token: ${{ secrets.GH_PAT }}

      - name: Update image reference
        run: |
          # Update image tag in manifests to use the new build
          cd manifests/applications/api-service
          kustomize edit set image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Validate Kustomize build
        run: |
          kubectl kustomize overlays/${{ github.event.inputs.environment || 'development' }} | kubeval -

      - name: Commit manifest changes
        if: github.ref == 'refs/heads/main'
        run: |
          cd manifests
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add -A
          git commit -m "chore: Update ${{ env.IMAGE_NAME }} to ${{ github.sha }}"
          git push

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [lint, test, build, integration-test]
    if: always()
    steps:
      - name: Get job status
        id: status
        run: |
          if [[ "${{ needs.lint.result }}" == "success" ]] && \
             [[ "${{ needs.test.result }}" == "success" ]] && \
             [[ "${{ needs.build.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        if: always() && github.event_name == 'push'
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ steps.status.outputs.status }}
          channel: deployments
          text: 'Build and test pipeline completed'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
