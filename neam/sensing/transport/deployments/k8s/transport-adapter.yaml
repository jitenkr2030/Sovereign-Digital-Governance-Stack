apiVersion: v1
kind: ConfigMap
metadata:
  name: transport-adapter-config
  namespace: neam
  labels:
    app: transport-adapter
data:
  CONFIG_YAML: |
    service:
      name: "transport-adapter"
      host: "0.0.0.0"
      port: 8086
      environment: "production"
      shutdown_timeout: 30s
    mqtt:
      enabled: true
      sources:
        - broker_url: "${MQTT_BROKER_URL}"
          client_id: "${MQTT_CLIENT_ID}"
          username: "${MQTT_USERNAME}"
          password: "${MQTT_PASSWORD}"
          clean_start: false
          topics:
            - "fleet/+/vehicle/+/telemetry"
            - "fleet/+/vehicle/+/gps"
            - "fleet/+/vehicle/+/status"
            - "fleet/+/vehicle/+/alerts"
            - "fleet/+/vehicle/+/emergency"
            - "fleet/+/vehicle/+/diagnostics"
            - "fleet/+/vehicle/+/debug"
          qos: 1
          criticality: "standard"
        - broker_url: "${MQTT_BROKER_URL_2}"
          client_id: "${MQTT_CLIENT_ID_2}"
          topics:
            - "transit/bus/+/telemetry"
            - "transit/train/+/telemetry"
            - "transit/tram/+/telemetry"
          qos: 1
          criticality: "standard"
      qos_by_criticality:
        critical: 2
        important: 1
        standard: 1
        background: 0
      keep_alive: 30s
      session_expiry: 3600s
      timeout: 10s
      retry_interval: 5s
      reconnect_wait: 1s
    kafka:
      brokers: "${KAFKA_BROKERS}"
      output_topic: "transport.telemetry"
      dlq_topic: "transport.dlq"
      version: "2.8.0"
      max_open_requests: 100
      dial_timeout: 10s
      write_timeout: 30s
    session:
      max_retries: 10
      initial_delay: 1s
      max_delay: 60s
      multiplier: 2.0
      health_check_interval: 30s
      reconnect_wait: 5s
      state_store_type: "redis"
      state_store_url: "redis://redis:6379"
    filtering:
      deadband_percent: 0.1
      spike_threshold: 20.0
      spike_window_size: 5
      rate_of_change_limit: 10.0
      quality_filter:
        - "Good"
        - "Questionable"
      min_reporting_interval: 100ms
      max_value: 1e9
      min_value: -1e9
      outlier_threshold: 3.0
    logging:
      level: "info"
      format: "json"
      output_path: "/var/log/neam"
      json_format: true
    monitoring:
      enabled: true
      port: 9092
      path: "/metrics"
      health_path: "/health"
---
apiVersion: v1
kind: Secret
metadata:
  name: transport-adapter-secrets
  namespace: neam
  labels:
    app: transport-adapter
type: Opaque
stringData:
  MQTT_PASSWORD: "${MQTT_PASSWORD}"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: transport-adapter
  namespace: neam
  labels:
    app: transport-adapter
    version: v1
spec:
  replicas: 3
  selector:
    matchLabels:
      app: transport-adapter
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
  template:
    metadata:
      labels:
        app: transport-adapter
        version: v1
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9092"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: transport-adapter
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
        - name: transport-adapter
          image: neam/transport-adapter:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8086
              name: http
            - containerPort: 9092
              name: metrics
          env:
            - name: KAFKA_BROKERS
              valueFrom:
                configMapKeyRef:
                  name: transport-adapter-config
                  key: KAFKA_BROKERS
            - name: MQTT_BROKER_URL
              valueFrom:
                configMapKeyRef:
                  name: transport-adapter-config
                  key: MQTT_BROKER_URL
            - name: MQTT_CLIENT_ID
              valueFrom:
                configMapKeyRef:
                  name: transport-adapter-config
                  key: MQTT_CLIENT_ID
            - name: MQTT_USERNAME
              valueFrom:
                configMapKeyRef:
                  name: transport-adapter-config
                  key: MQTT_USERNAME
            - name: MQTT_BROKER_URL_2
              valueFrom:
                configMapKeyRef:
                  name: transport-adapter-config
                  key: MQTT_BROKER_URL_2
            - name: MQTT_CLIENT_ID_2
              valueFrom:
                configMapKeyRef:
                  name: transport-adapter-config
                  key: MQTT_CLIENT_ID_2
          envFrom:
            - secretRef:
                name: transport-adapter-secrets
          volumeMounts:
            - name: config
              mountPath: /etc/neam
              readOnly: true
            - name: logs
              mountPath: /var/log/neam
          resources:
            requests:
              cpu: "500m"
              memory: "256Mi"
            limits:
              cpu: "2000m"
              memory: "512Mi"
          livenessProbe:
            httpGet:
              path: /health
              port: 9092
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 9092
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
      volumes:
        - name: config
          configMap:
            name: transport-adapter-config
        - name: logs
          emptyDir: {}
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app: transport-adapter
                topologyKey: kubernetes.io/hostname
---
apiVersion: v1
kind: Service
metadata:
  name: transport-adapter
  namespace: neam
  labels:
    app: transport-adapter
spec:
  type: ClusterIP
  ports:
    - port: 8086
      targetPort: 8086
      protocol: TCP
      name: http
    - port: 9092
      targetPort: 9092
      protocol: TCP
      name: metrics
  selector:
    app: transport-adapter
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: transport-adapter
  namespace: neam
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: transport-adapter
  minReplicas: 3
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: transport-adapter
  namespace: neam
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  tls:
    - hosts:
        - transport-adapter.neam.example.com
      secretName: transport-adapter-tls
  rules:
    - host: transport-adapter.neam.example.com
      http:
        paths:
          - path: /metrics
            pathType: Prefix
            backend:
              service:
                name: transport-adapter
                port:
                  number: 9092
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: transport-adapter
  namespace: neam
  labels:
    release: prometheus
spec:
  selector:
    matchLabels:
      app: transport-adapter
  namespaceSelector:
    matchNames:
      - neam
  endpoints:
    - port: metrics
      path: /metrics
      interval: 15s
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: transport-adapter-alerts
  namespace: neam
  labels:
    release: prometheus
spec:
  groups:
    - name: transport-adapter
      rules:
        - alert: TransportAdapterDown
          expr: up{job="transport-adapter"} == 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Transport adapter is down"
            description: "The transport adapter has been down for more than 5 minutes"
        - alert: TransportAdapterHighLatency
          expr: histogram_quantile(0.95, rate(transport_adapter_processing_latency_seconds_bucket[5m])) > 0.01
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Transport adapter high latency"
            description: "Transport adapter processing latency is above 10ms"
        - alert: TransportAdapterHighFilterRate
          expr: rate(transport_adapter_points_filtered_total[5m]) / rate(transport_adapter_points_processed_total[5m]) > 0.5
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High filter rate detected"
            description: "More than 50% of points are being filtered"
        - alert: TransportAdapterMQTTDisconnected
          expr: transport_adapter_mqtt_connected == 0
          for: 1m
          labels:
            severity: warning
          annotations:
            summary: "MQTT connection lost"
            description: "MQTT broker connection has been lost"
        - alert: TransportAdapterKafkaUnhealthy
          expr: transport_adapter_kafka_healthy == 0
          for: 1m
          labels:
            severity: warning
          annotations:
            summary: "Kafka connection unhealthy"
            description: "Kafka producer connection is unhealthy"
