apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-rules
  namespace: neam
  labels:
    app: prometheus
data:
  energy-adapter-rules.yml: |
    groups:
      - name: energy-adapter.rules
        rules:
          - record: energy_adapter:points_processed:rate5m
            expr: rate(energy_adapter_points_processed_total[5m])

          - record: energy_adapter:points_filtered:rate5m
            expr: rate(energy_adapter_points_filtered_total[5m])

          - record: energy_adapter:filter_ratio:5m
            expr: |
              rate(energy_adapter_points_filtered_total[5m])
              /
              rate(energy_adapter_points_processed_total[5m])

          - record: energy_adapter:spikes_detected:rate5m
            expr: rate(energy_adapter_spikes_detected_total[5m])

          - record: energy_adapter:anomalies_detected:rate5m
            expr: rate(energy_adapter_anomalies_detected_total[5m])

          - record: energy_adapter:connection_health:ratio
            expr: |
              sum(energy_adapter_connection_health)
              /
              count(energy_adapter_connection_health)

          - record: energy_adapter:processing_latency:p95
            expr: histogram_quantile(0.95, rate(energy_adapter_processing_latency_seconds_bucket[5m]))

          - record: energy_adapter:processing_latency:p99
            expr: histogram_quantile(0.99, rate(energy_adapter_processing_latency_seconds_bucket[5m]))

          - record: energy_adapter:kafka_messages_sent:rate1m
            expr: rate(kafka_producer_messages_sent_total[1m])

          - record: energy_adapter:kafka_bytes_sent:rate1m
            expr: rate(kafka_producer_bytes_sent_total[1m])

  node-exporter-rules.yml: |
    groups:
      - name: node-exporter.rules
        rules:
          - record: node_cpu:cpu_usage:rate5m
            expr: sum(rate(node_cpu_seconds_total{mode!="idle"}[5m])) by (instance)

          - record: node_memory:memory_usage:ratio
            expr: 1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)

          - record: node_disk:disk_io_time:rate5m
            expr: rate(node_disk_io_time_seconds_total[5m])

          - record: node_network:network_traffic:rate5m
            expr: sum(rate(node_network_receive_bytes_total[5m]) + rate(node_network_transmit_bytes_total[5m])) by (instance)
