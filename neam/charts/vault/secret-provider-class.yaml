# Vault Secret ProviderClass for Kubernetes CSI Driver
# This resource configures the CSI driver to retrieve secrets from Vault
# Namespace: kube-system or per-namespace with RBAC

apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: neam-vault-secrets
  namespace: neam-platform
  labels:
    app.kubernetes.io/name: neam-platform
    app.kubernetes.io/component: secrets
    app.kubernetes.io/part-of: neam-platform
spec:
  provider: vault
  parameters:
    # Vault Address
    vaultAddress: "https://vault.neam.io:8200"
    
    # Vault TLS Configuration
    vaultCACert: "/vault/tls/ca.crt"
    vaultTLSClientCert: "/vault/tls/client.crt"
    vaultTLSClientKey: "/vault/tls/client.key"
    vaultSkipVerify: "false"
    
    # Vault Role for Kubernetes Authentication
    roleName: "neam-production"
    
    # Kubernetes Auth Path
    kubernetesAuthPath: "kubernetes"
    
    # Objects to retrieve from Vault
    objects: |
      # Database Secrets
      - objectName: "postgresql-username"
        secretPath: "secret/production/database/postgresql"
        secretKey: "username"
      - objectName: "postgresql-password"
        secretPath: "secret/production/database/postgresql"
        secretKey: "password"
      - objectName: "postgresql-connection-string"
        secretPath: "secret/production/database/postgresql"
        secretKey: "connection_string"
      
      - objectName: "redis-password"
        secretPath: "secret/production/database/redis"
        secretKey: "password"
      - objectName: "redis-connection-string"
        secretPath: "secret/production/database/redis"
        secretKey: "connection_string"
      
      # Kafka Secrets
      - objectName: "kafka-sasl-username"
        secretPath: "secret/production/kafka"
        secretKey: "sasl_username"
      - objectName: "kafka-sasl-password"
        secretPath: "secret/production/kafka"
        secretKey: "sasl_password"
      - objectName: "kafka-ssl-cert"
        secretPath: "secret/production/kafka"
        secretKey: "ssl_cert"
      - objectName: "kafka-ssl-key"
        secretPath: "secret/production/kafka"
        secretKey: "ssl_key"
      
      # MongoDB Secrets
      - objectName: "mongodb-username"
        secretPath: "secret/production/mongodb"
        secretKey: "username"
      - objectName: "mongodb-password"
        secretPath: "secret/production/mongodb"
        secretKey: "password"
      - objectName: "mongodb-connection-string"
        secretPath: "secret/production/mongodb"
        secretKey: "connection_string"
      
      # Elasticsearch Secrets
      - objectName: "elasticsearch-api-key"
        secretPath: "secret/production/elasticsearch"
        secretKey: "api_key"
      - objectName: "elasticsearch-username"
        secretPath: "secret/production/elasticsearch"
        secretKey: "username"
      - objectName: "elasticsearch-password"
        secretPath: "secret/production/elasticsearch"
        secretKey: "password"
      
      # External Services
      - objectName: "external-api-keys"
        secretPath: "secret/production/external"
        secretKey: "api_keys"
      - objectName: "webhook-urls"
        secretPath: "secret/production/external"
        secretKey: "webhook_urls"
      
      # Application Secrets
      - objectName: "jwt-secret"
        secretPath: "secret/production/application"
        secretKey: "jwt_secret"
      - objectName: "encryption-key"
        secretPath: "secret/production/application"
        secretKey: "encryption_key"
      - objectName: "session-secret"
        secretPath: "secret/production/application"
        secretKey: "session_secret"
    
    # Secret Refresh Configuration
    secretRefreshRate: "120s"
    secretGracePeriod: "30s"
    
    # Multiline configuration
    multiLine: "false"
