apiVersion: v1
kind: Namespace
metadata:
  name: registry
  labels:
    app: local-registry
    tier: infrastructure
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: local-registry
  namespace: registry
---
apiVersion: v1
kind: Service
metadata:
  name: local-registry
  namespace: registry
  labels:
    app: local-registry
  annotations:
    description: "Local OCI registry service"
spec:
  type: ClusterIP
  ports:
    - name: registry
      port: 5000
      targetPort: 5000
      protocol: TCP
    - name: metrics
      port: 5001
      targetPort: 5001
      protocol: TCP
  selector:
    app: local-registry
---
apiVersion: v1
kind: Service
metadata:
  name: local-registry-headless
  namespace: registry
  labels:
    app: local-registry
spec:
  clusterIP: None
  ports:
    - name: registry
      port: 5000
      targetPort: 5000
  selector:
    app: local-registry
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: local-registry
  namespace: registry
  labels:
    app: local-registry
    tier: infrastructure
  annotations:
    description: "Local OCI container registry for air-gapped deployments"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: local-registry
  template:
    metadata:
      labels:
        app: local-registry
        tier: infrastructure
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "5001"
    spec:
      serviceAccountName: local-registry
      terminationGracePeriodSeconds: 30
      
      securityContext:
        runAsNonRoot: true
        runAsUser: 10000
        runAsGroup: 10000
        fsGroup: 10000
      
      containers:
        - name: registry
          image: docker.io/library/registry:2.8
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 5000
              name: registry
            - containerPort: 5001
              name: metrics
          env:
            - name: REGISTRY_HTTP_ADDR
              value: ":5000"
            - name: REGISTRY_HTTP_METRICS_ADDR
              value: ":5001"
            - name: REGISTRY_STORAGE_DELETE_ENABLED
              value: "true"
            - name: REGISTRY_STORAGE_MAINTENANCE_UPLOAD_PURGE_ENABLED
              value: "true"
            - name: REGISTRY_LOG_LEVEL
              value: "info"
            - name: REGISTRY_LOG_FORMAT
              value: "json"
            # Storage configuration
            - name: REGISTRY_STORAGE
              value: "filesystem"
            - name: REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY
              value: "/var/lib/registry"
            # Health check
            - name: REGISTRY_HEALTH_STORAGEDRIVER_ENABLED
              value: "true"
            - name: REGISTRY_HEALTH_STORAGEDRIVER_TIMEOUT
              value: "10s"
          volumeMounts:
            - name: registry-data
              mountPath: /var/lib/registry
            - name: registry-config
              mountPath: /etc/docker/registry
              readOnly: true
          livenessProbe:
            httpGet:
              path: /v2/
              port: 5000
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /v2/
              port: 5000
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "1000m"
              memory: "1Gi"
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL
      volumes:
        - name: registry-data
          persistentVolumeClaim:
            claimName: registry-pvc
        - name: registry-config
          configMap:
            name: registry-config
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: registry-config
  namespace: registry
  labels:
    app: local-registry
data:
  config.yml: |
    version: 0.1
    log:
      level: info
      formatter: json
    http:
      addr: :5000
      headers:
        X-Content-Type-Options: [nosniff]
    health:
      storagedriver:
        enabled: true
        threshold: 10
    storage:
      filesystem:
        rootdirectory: /var/lib/registry
      delete:
        enabled: true
      maintenance:
        uploadpurging:
          enabled: true
          age: 168h
          interval: 24h
          dryrun: false
    proxy:
      remoteurl: https://registry-1.docker.io
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: registry-pvc
  namespace: registry
  labels:
    app: local-registry
  annotations:
    description: "Persistent storage for local registry"
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 50Gi
  storageClassName: fast-regional
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: local-registry
  namespace: registry
  labels:
    app: local-registry
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      app: local-registry
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: registry-network-policy
  namespace: registry
  labels:
    app: local-registry
spec:
  podSelector:
    matchLabels:
      app: local-registry
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: default
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: TCP
          port: 5000
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: registry-admin
  namespace: registry
rules:
  - apiGroups: [""]
    resources: ["pods", "services", "configmaps", "persistentvolumeclaims"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["apps"]
    resources: ["deployments"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: registry-admin-binding
  namespace: registry
subjects:
  - kind: ServiceAccount
    name: local-registry
    namespace: registry
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: registry-admin
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: registry-tls
  namespace: registry
spec:
  secretName: registry-tls-secret
  duration: 8760h
  renewBefore: 720h
  issuerRef:
    name: neam-internal-ca
    kind: Issuer
  dnsNames:
    - local-registry.registry.svc
    - local-registry.registry.svc.cluster.local
    - local-registry
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: registry-ingress
  namespace: registry
  labels:
    app: local-registry
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "0"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
spec:
  tls:
    - hosts:
        - local-registry.neam.internal
      secretName: registry-tls-secret
  rules:
    - host: local-registry.neam.internal
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: local-registry
                port:
                  number: 5000
