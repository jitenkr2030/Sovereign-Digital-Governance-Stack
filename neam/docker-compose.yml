# NEAM Platform Docker Compose Configuration
# Orchestrates all layers: Sensing, Intelligence, Policy, Simulation, Dashboard
# Version: 3.9

services:
  # =============================================================================
  # Layer 1: Sensing Layer - Data Ingestion Services
  # =============================================================================

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: neam-kafka
    hostname: kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_DELETE_TOPIC_ENABLE: "true"
      KAFKA_LOG_RETENTION_HOURS: 168
      KAFKA_MESSAGE_MAX_BYTES: 10485760
    depends_on:
      - zookeeper
    networks:
      - neam-network
    healthcheck:
      test: ["CMD", "kafka-topics.sh", "--bootstrap-server", "kafka:29092", "--list"]
      interval: 10s
      timeout: 10s
      retries: 5

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: neam-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - neam-network
    healthcheck:
      test: ["CMD", "zkServer.sh", "status"]
      interval: 10s
      timeout: 10s
      retries: 5

  redis:
    image: redis:7.2-alpine
    container_name: neam-redis
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - neam-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  nats:
    image: nats:2.9-alpine
    container_name: neam-nats
    ports:
      - "4222:4222"
      - "8222:8222"
    command: -js -m 8222
    networks:
      - neam-network
    healthcheck:
      test: ["CMD", "nats", "-s", "localhost:4222", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # =============================================================================
  # Payment Adapter Service - ISO 20022 and SWIFT Message Processing
  # =============================================================================

  neam-payment-adapter:
    build:
      context: ./sensing/payments
      dockerfile: Dockerfile
    container_name: neam-payment-adapter
    ports:
      - "9090:9090"
      - "8084:8084"
    environment:
      - SERVICE_NAME=payment-adapter
      - SERVICE_HOST=0.0.0.0
      - SERVICE_PORT=8084
      - KAFKA_BROKERS=kafka:29092
      - KAFKA_CONSUMER_GROUP=neam-payment-group-v1
      - KAFKA_INPUT_TOPIC=payments.raw
      - KAFKA_OUTPUT_TOPIC=payments.normalized
      - KAFKA_DLQ_TOPIC=payments.dlq
      - REDIS_ADDR=redis:6379
      - REDIS_PASSWORD=
      - REDIS_DB=0
      - PROCESSING_MODE=realtime
      - WORKER_COUNT=10
      - BATCH_SIZE=100
      - MAX_RETRIES=5
      - INITIAL_DELAY=100ms
      - MAX_DELAY=10s
      - LOG_LEVEL=info
      - LOG_FORMAT=json
      - MONITORING_ENABLED=true
      - METRICS_PORT=9090
      - HEALTH_PATH=/health
    volumes:
      - payment-adapter-data:/app/data
      - payment-adapter-logs:/app/logs
    depends_on:
      kafka:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - neam-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8084/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    restart: unless-stopped

  # =============================================================================
  # Layer 2: Economic Intelligence Engine
  # =============================================================================

  neam-intelligence:
    build:
      context: ./intelligence
      dockerfile: Dockerfile
    container_name: neam-intelligence
    ports:
      - "8081:8081"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - CLICKHOUSE_HOST=clickhouse
      - CLICKHOUSE_PORT=9000
      - CONFIG_PATH=/app/config.yaml
    depends_on:
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
    networks:
      - neam-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # =============================================================================
  # Black Economy Intelligence Service - Shadow Economy Detection
  # =============================================================================

  neam-black-economy:
    build:
      context: ./black-economy
      dockerfile: Dockerfile
    container_name: neam-black-economy
    ports:
      - "8085:8085"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - CLICKHOUSE_HOST=clickhouse
      - CLICKHOUSE_PORT=9000
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - CONFIG_PATH=/app/config/config.yaml
    depends_on:
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - neam-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8085/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # =============================================================================
  # Feature Store Service - ML Feature Management
  # =============================================================================

  neam-feature-store:
    build:
      context: ./feature-store
      dockerfile: Dockerfile
    container_name: neam-feature-store
    ports:
      - "8086:8086"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - CONFIG_PATH=/app/config/config.yaml
    depends_on:
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - neam-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8086/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # =============================================================================
  # Macro-Economic Modeling Service - GDP & Inflation Forecasting
  # =============================================================================

  neam-macro:
    build:
      context: ./macro
      dockerfile: Dockerfile
    container_name: neam-macro
    ports:
      - "8087:8087"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - CLICKHOUSE_HOST=clickhouse
      - CLICKHOUSE_PORT=9000
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - CONFIG_PATH=/app/config/config.yaml
    depends_on:
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - neam-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8087/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # =============================================================================
  # Layer 3: Policy & Intervention Engine
  # =============================================================================

  neam-policy:
    build:
      context: ./policy
      dockerfile: Dockerfile
    container_name: neam-policy
    ports:
      - "8082:8082"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - CONFIG_PATH=/app/config.yaml
    depends_on:
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - neam-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8082/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # =============================================================================
  # Layer 3: Python Simulation Service (What-If Analysis)
  # =============================================================================

  neam-simulation:
    build:
      context: ./simulation
      dockerfile: Dockerfile
    container_name: neam-simulation
    ports:
      - "8083:8083"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - CONFIG_PATH=/app/config.yaml
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - neam-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8083/api/v1/health/live')"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # =============================================================================
  # Layer 4: Government Decision Dashboard
  # =============================================================================

  neam-dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    container_name: neam-dashboard
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_API_URL=http://localhost:8080/api/v1
      - REACT_APP_WS_URL=ws://localhost:8080/ws
    depends_on:
      - neam-api-gateway
    networks:
      - neam-network
    restart: unless-stopped

  neam-api-gateway:
    image: nginx:1.25-alpine
    container_name: neam-api-gateway
    ports:
      - "8080:8080"
    volumes:
      - ./gateway/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - neam-intelligence
      - neam-black-economy
      - neam-feature-store
      - neam-macro
      - neam-policy
      - neam-simulation
      - neam-payment-adapter
    networks:
      - neam-network
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =============================================================================
  # Data Layer: Databases
  # =============================================================================

  postgres:
    image: postgres:15-alpine
    container_name: neam-postgres
    environment:
      POSTGRES_USER: neam_user
      POSTGRES_PASSWORD: neam_password
      POSTGRES_DB: neam_db
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    networks:
      - neam-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U neam_user -d neam_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  clickhouse:
    image: clickhouse/clickhouse-server:23.12-alpine
    container_name: neam-clickhouse
    environment:
      CLICKHOUSE_DB: neam_analytics
      CLICKHOUSE_USER: neam_user
      CLICKHOUSE_PASSWORD: neam_password
    volumes:
      - clickhouse-data:/var/lib/clickhouse
      - ./database/clickhouse-init.sql:/docker-entrypoint-initdb.d/01-clickhouse-init.sql
    ports:
      - "8123:8123"
      - "9000:9000"
    networks:
      - neam-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 10s
      retries: 5

  # =============================================================================
  # Object Storage (for Feature Store)
  # =============================================================================

  minio:
    image: minio/minio:RELEASE.2024-01-01T00-00-00Z
    container_name: neam-minio
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio-data:/data
    networks:
      - neam-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # =============================================================================
  # Monitoring & Observability
  # =============================================================================

  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: neam-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
      - ./monitoring/payment-adapter-rules.yml:/etcrometheus/rules/payment-adapter-rules.yml:ro
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
      - '--rules.external.url=http://alertmanager:9093'
    networks:
      - neam-network
    depends_on:
      - neam-intelligence
      - neam-black-economy
      - neam-feature-store
      - neam-macro
      - neam-policy
      - neam-simulation
      - neam-payment-adapter

  grafana:
    image: grafana/grafana:10.2.2
    container_name: neam-grafana
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=neam_admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH=/etc/grafana/provisioning/dashboards/neam-platform-overview.json
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
    depends_on:
      - prometheus
    networks:
      - neam-network

  alertmanager:
    image: prom/alertmanager:v0.26.0
    container_name: neam-alertmanager
    ports:
      - "9093:9093"
    volumes:
      - ./monitoring/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager-data:/alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    networks:
      - neam-network

  # =============================================================================
  # Kafka UI for Development and Monitoring
  # =============================================================================

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: neam-kafka-ui
    ports:
      - "8088:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: neam-local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
    depends_on:
      - kafka
      - zookeeper
    networks:
      - neam-network

  # =============================================================================
  # Redis Commander for Redis Monitoring
  # =============================================================================

  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: neam-redis-commander
    ports:
      - "8089:8081"
    environment:
      - REDIS_HOSTS=local:redis:6379
    depends_on:
      - redis
    networks:
      - neam-network

  # =============================================================================
  # Networks & Volumes
  # =============================================================================

networks:
  neam-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  redis-data:
    driver: local
  postgres-data:
    driver: local
  clickhouse-data:
    driver: local
  minio-data:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
  alertmanager-data:
    driver: local
  payment-adapter-data:
    driver: local
  payment-adapter-logs:
    driver: local


# =============================================================================
# Service Endpoints Summary
# =============================================================================
#
# Layer 1 - Sensing:
#   - Kafka:        localhost:9092
#   - Redis:        localhost:6379
#   - NATS:         localhost:4222
#   - MinIO:        localhost:9000 (S3-compatible storage)
#   - Kafka UI:     localhost:8088
#   - Redis UI:     localhost:8089
#
# Payment Adapter:
#   - Health:       http://localhost:8084/health
#   - Metrics:      http://localhost:9090/metrics
#
# Layer 2 - Intelligence:
#   - API:          localhost:8081
#
# Layer 2 - Black Economy:
#   - Shadow Econ:  localhost:8085
#
# Layer 2 - Feature Store:
#   - ML Features:  localhost:8086
#
# Layer 2 - Macro Models:
#   - GDP/Forecast: localhost:8087
#
# Layer 3 - Policy:
#   - API:          localhost:8082
#
# Layer 3 - Simulation:
#   - API (REST):   localhost:8083
#   - Swagger UI:   http://localhost:8083/docs
#
# Layer 4 - Dashboard:
#   - Web UI:       http://localhost:3000
#   - API Gateway:  http://localhost:8080
#
# Data Layer:
#   - PostgreSQL:   localhost:5432
#   - ClickHouse:   localhost:8123
#   - MinIO:        localhost:9000
#
# Monitoring:
#   - Prometheus:   localhost:9090
#   - Grafana:      http://localhost:3001
#   - Alertmanager: localhost:9093
#
# =============================================================================

# =============================================================================
# Quick Start Commands
# =============================================================================
#
# Start all services:
#   docker-compose up -d
#
# Start with monitoring:
#   docker-compose -f docker-compose.yml up -d prometheus grafana alertmanager
#
# View logs:
#   docker-compose logs -f neam-payment-adapter
#
# Run tests:
#   docker-compose exec neam-payment-adapter go test -v /app/...
#
# Scale payment adapter:
#   docker-compose up -d --scale neam-payment-adapter=3
#
# Stop all services:
#   docker-compose down
#
# =============================================================================
