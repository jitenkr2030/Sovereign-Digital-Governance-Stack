# Application Chaos Experiments
# Service-level chaos experiments for testing application resilience

apiVersion: chaos-mesh.org/v1alpha1
kind: HTTPChaos
metadata:
  name: service-latency-inject
  namespace: chaos-testing
  labels:
    experiment: http-chaos
    severity: medium
spec:
  selector:
    namespaces:
      - production
    labelSelectors:
      app: payment-processor
  mode: one
  action: delay
  delay: 500ms
  percent: "30"
  target: Service
  port: 8080
  path: "/api/v1/payments"
  methods:
    - POST
    - PUT
  duration: 10m
---
apiVersion: chaos-mesh.org/v1alpha1
kind: HTTPChaos
metadata:
  name: service-latency-all-paths
  namespace: chaos-testing
  labels:
    experiment: http-chaos
    severity: medium
spec:
  selector:
    namespaces:
      - production
    labelSelectors:
      app: api-gateway
  mode: all
  action: delay
  delay: 200ms
  percent: "20"
  target: Service
  port: 8080
  duration: 15m
---
apiVersion: chaos-mesh.org/v1alpha1
kind: HTTPChaos
metadata:
  name: service-error-500
  namespace: chaos-testing
  labels:
    experiment: http-chaos
    severity: high
spec:
  selector:
    namespaces:
      - production
    labelSelectors:
      app: auth-service
  mode: one
  action: abort
  target: Service
  port: 8080
  path: "/api/v1/auth/token"
  methods:
    - POST
  percent: "10"
  duration: 5m
---
apiVersion: chaos-mesh.org/v1alpha1
kind: HTTPChaos
metadata:
  name: service-error-custom-response
  namespace: chaos-testing
  labels:
    experiment: http-chaos
    severity: high
spec:
  selector:
    namespaces:
      - production
    labelSelectors:
      app: analytics-engine
  mode: one
  action: response
  target: Service
  port: 8080
  path: "/api/v1/analytics"
  methods:
    - GET
  percent: "15"
  code: 503
  body: '{"error": "Service temporarily unavailable", "retry_after": 30}'
  duration: 5m
---
apiVersion: chaos-mesh.org/v1alpha1
kind: HTTPChaos
metadata:
  name: service-mixed-errors
  namespace: chaos-testing
  labels:
    experiment: http-chaos
    severity: medium
spec:
  selector:
    namespaces:
      - production
  mode: all
  action: mixed
  delay: 100ms
  percent: "10"
  abortPercent: "5"
  target: Service
  port: 8080
  duration: 10m
---
apiVersion: chaos-mesh.org/v1alpha1
kind: HTTPChaos
metadata:
  name: database-connection-delay
  namespace: chaos-testing
  labels:
    experiment: database-chaos
    severity: high
spec:
  selector:
    namespaces:
      - production
    labelSelectors:
      app: postgres-primary
  mode: one
  action: delay
  delay: 1000ms
  percent: "25"
  target: Service
  port: 5432
  duration: 10m
---
apiVersion: chaos-mesh.org/v1alpha1
kind: HTTPChaos
metadata:
  name: database-connection-error
  namespace: chaos-testing
  labels:
    experiment: database-chaos
    severity: critical
spec:
  selector:
    namespaces:
      - production
    labelSelectors:
      app: postgres-primary
  mode: one
  action: abort
  target: Service
  port: 5432
  percent: "5"
  duration: 2m
---
apiVersion: chaos-mesh.org/v1alpha1
kind: TCPChaos
metadata:
  name: cache-connection-delay
  namespace: chaos-testing
  labels:
    experiment: cache-chaos
    severity: medium
spec:
  selector:
    namespaces:
      - production
    labelSelectors:
      app: redis-cache
  mode: one
  action: delay
  delay: 200ms
  percent: "20"
  target:
    selector:
      namespaces:
        - production
      labelSelectors:
        app: payment-processor
    port: 6379
  duration: 10m
---
apiVersion: chaos-mesh.org/v1alpha1
kind: TCPChaos
metadata:
  name: cache-connection-error
  namespace: chaos-testing
  labels:
    experiment: cache-chaos
    severity: critical
spec:
  selector:
    namespaces:
      - production
    labelSelectors:
      app: redis-cache
  mode: one
  action: abort
  percent: "10"
  target:
    selector:
      namespaces:
        - production
      labelSelectors:
        app: auth-service
    port: 6379
  duration: 3m
---
apiVersion: chaos-mesh.org/v1alpha1
kind: TCPChaos
metadata:
  name: cache-connection-loss
  namespace: chaos-testing
  labels:
    experiment: cache-chaos
    severity: high
spec:
  selector:
    namespaces:
      - production
  mode: all
  action: loss
  loss: "15"
  correlation: "30"
  target:
    selector:
      namespaces:
        - production
      labelSelectors:
        tier: api
    port: 6379
  duration: 5m
---
apiVersion: chaos-mesh.org/v1alpha1
kind: TCPChaos
metadata:
  name: message-queue-disruption
  namespace: chaos-testing
  labels:
    experiment: mq-chaos
    severity: critical
spec:
  selector:
    namespaces:
      - production
    labelSelectors:
      app: kafka-broker
  mode: one
  action: delay
  delay: 500ms
  percent: "20"
  target:
    selector:
      namespaces:
        - production
      labelSelectors:
        app: transaction-auditor
    port: 9092
  duration: 10m
---
apiVersion: chaos-mesh.org/v1alpha1
kind: TCPChaos
metadata:
  name: message-queue-connection-error
  namespace: chaos-testing
  labels:
    experiment: mq-chaos
    severity: critical
spec:
  selector:
    namespaces:
      - production
  mode: all
  action: abort
  percent: "5"
  target:
    selector:
      namespaces:
        - production
      labelSelectors:
        tier: worker
    port: 9092
  duration: 2m
---
apiVersion: chaos-mesh.org/v1alpha1
kind: Workflow
metadata:
  name: application-resilience-test
  namespace: chaos-testing
spec:
  entry: serial-app-test
  templates:
    - name: serial-app-test
      templateType: Serial
      deadline: 1h
      children:
        - latency-injection
        - error-injection
        - recovery-test

    - name: latency-injection
      templateType: HTTPChaos
      deadline: 20m
      httpChaos:
        selector:
          namespaces:
            - production
          labelSelectors:
            app: payment-processor
        mode: one
        action: delay
        delay: 300ms
        percent: "25"
        target: Service
        port: 8080

    - name: error-injection
      templateType: HTTPChaos
      deadline: 20m
      httpChaos:
        selector:
          namespaces:
            - production
          labelSelectors:
            app: auth-service
        mode: one
        action: abort
        target: Service
        port: 8080
        percent: "10"

    - name: recovery-test
      templateType: PodChaos
      deadline: 10m
      podChaos:
        selector:
          namespaces:
            - production
          labelSelectors:
            app: redis-cache
        mode: one
        action: pod-failure
---
apiVersion: chaos-mesh.org/v1alpha1
kind: Workflow
metadata:
  name: database-failover-test
  namespace: chaos-testing
spec:
  entry: db-chaos-workflow
  templates:
    - name: db-chaos-workflow
      templateType: Serial
      deadline: 30m
      children:
        - db-connection-delay
        - db-pod-failure
        - db-recovery

    - name: db-connection-delay
      templateType: HTTPChaos
      deadline: 5m
      httpChaos:
        selector:
          namespaces:
            - production
          labelSelectors:
            app: postgres-primary
        mode: one
        action: delay
        delay: 500ms
        percent: "50"
        target: Service
        port: 5432

    - name: db-pod-failure
      templateType: PodChaos
      deadline: 10m
      podChaos:
        selector:
          namespaces:
            - production
          labelSelectors:
            app: postgres-primary
        mode: one
        action: pod-failure

    - name: db-recovery
      templateType: Duration
      deadline: 5m
      duration: 5m
---
apiVersion: chaos-mesh.org/v1alpha1
kind: Workflow
metadata:
  name: cache-failover-test
  namespace: chaos-testing
spec:
  entry: cache-chaos-workflow
  templates:
    - name: cache-chaos-workflow
      templateType: Serial
      deadline: 20m
      children:
        - cache-delay
        - cache-error
        - cache-purge
        - cache-recovery

    - name: cache-delay
      templateType: TCPChaos
      deadline: 5m
      tcpChaos:
        selector:
          namespaces:
            - production
          labelSelectors:
            app: redis-cache
        mode: one
        action: delay
        delay: 200ms
        percent: "30"
        target:
          selector:
            namespaces:
              - production
            labelSelectors:
              app: api-gateway
          port: 6379

    - name: cache-error
      templateType: TCPChaos
      deadline: 3m
      tcpChaos:
        selector:
          namespaces:
            - production
          labelSelectors:
            app: redis-cache
        mode: one
        action: abort
        percent: "10"

    - name: cache-purge
      templateType: IOChaos
      deadline: 2m
      ioChaos:
        selector:
          namespaces:
            - production
          labelSelectors:
            app: redis-cache
        mode: one
        action: errno
        errno: "1"  # EPERM - Operation not permitted
        percent: "100"
        path: /data
        volumePath: /data

    - name: cache-recovery
      templateType: Duration
      deadline: 5m
      duration: 5m
---
apiVersion: chaos-mesh.org/v1alpha1
kind: Workflow
metadata:
  name: message-queue-resilience-test
  namespace: chaos-testing
spec:
  entry: mq-chaos-workflow
  templates:
    - name: mq-chaos-workflow
      templateType: Serial
      deadline: 45m
      children:
        - mq-producer-delay
        - mq-consumer-error
        - mq-broker-failure
        - mq-recovery

    - name: mq-producer-delay
      templateType: TCPChaos
      deadline: 10m
      tcpChaos:
        selector:
          namespaces:
            - production
          labelSelectors:
            app: kafka-broker
        mode: all
        action: delay
        delay: 300ms
        percent: "20"
        target:
          selector:
            namespaces:
              - production
            labelSelectors:
              app: payment-processor
          port: 9092

    - name: mq-consumer-error
      templateType: TCPChaos
      deadline: 10m
      tcpChaos:
        selector:
          namespaces:
            - production
          labelSelectors:
            app: kafka-broker
        mode: all
        action: abort
        percent: "5"
        target:
          selector:
            namespaces:
              - production
            labelSelectors:
              app: transaction-auditor
          port: 9092

    - name: mq-broker-failure
      templateType: PodChaos
      deadline: 10m
      podChaos:
        selector:
          namespaces:
            - production
          labelSelectors:
            app: kafka-broker
        mode: one
        action: pod-failure

    - name: mq-recovery
      templateType: Duration
      deadline: 10m
      duration: 10m
---
apiVersion: chaos-mesh.org/v1alpha1
kind: Workflow
metadata:
  name: auth-service-resilience-test
  namespace: chaos-testing
spec:
  entry: auth-resilience
  templates:
    - name: auth-resilience
      templateType: Serial
      deadline: 30m
      children:
        - token-service-delay
        - token-service-error
        - db-connection-issue
        - cache-miss-storm

    - name: token-service-delay
      templateType: HTTPChaos
      deadline: 5m
      httpChaos:
        selector:
          namespaces:
            - production
          labelSelectors:
            app: auth-service
        mode: one
        action: delay
        delay: 1000ms
        percent: "40"
        target: Service
        port: 8080
        path: "/api/v1/auth/token"
        methods:
          - POST

    - name: token-service-error
      templateType: HTTPChaos
      deadline: 5m
      httpChaos:
        selector:
          namespaces:
            - production
          labelSelectors:
            app: auth-service
        mode: one
        action: abort
        target: Service
        port: 8080
        path: "/api/v1/auth/token"
        methods:
          - POST
        percent: "10"

    - name: db-connection-issue
      templateType: HTTPChaos
      deadline: 5m
      httpChaos:
        selector:
          namespaces:
            - production
          labelSelectors:
            app: auth-service
        mode: one
        action: delay
        delay: 500ms
        percent: "30"
        target: Service
        port: 5432

    - name: cache-miss-storm
      templateType: TCPChaos
      deadline: 5m
      tcpChaos:
        selector:
          namespaces:
            - production
          labelSelectors:
            app: redis-cache
        mode: all
        action: loss
        loss: "20"
        target:
          selector:
            namespaces:
              - production
            labelSelectors:
              app: auth-service
          port: 6379
---
apiVersion: chaos-mesh.org/v1alpha1
kind: Workflow
metadata:
  name: complete-application-chaos-test
  namespace: chaos-testing
spec:
  entry: full-chaos-test
  templates:
    - name: full-chaos-test
      templateType: Serial
      deadline: 2h
      children:
        - api-gateway-tests
        - auth-service-tests
        - payment-service-tests
        - data-service-tests

    - name: api-gateway-tests
      templateType: Parallel
      deadline: 30m
      children:
        - gw-latency
        - gw-error
        - gw-pod-failure

    - name: gw-latency
      templateType: HTTPChaos
      httpChaos:
        selector:
          namespaces:
            - production
          labelSelectors:
            app: api-gateway
        mode: one
        action: delay
        delay: 200ms
        percent: "20"
        target: Service
        port: 8080

    - name: gw-error
      templateType: HTTPChaos
      httpChaos:
        selector:
          namespaces:
            - production
          labelSelectors:
            app: api-gateway
        mode: one
        action: abort
        target: Service
        port: 8080
        percent: "5"

    - name: gw-pod-failure
      templateType: PodChaos
      podChaos:
        selector:
          namespaces:
            - production
          labelSelectors:
            app: api-gateway
        mode: one
        action: pod-failure

    - name: auth-service-tests
      templateType: Parallel
      deadline: 30m
      children:
        - auth-delay
        - auth-error

    - name: auth-delay
      templateType: HTTPChaos
      httpChaos:
        selector:
          namespaces:
            - production
          labelSelectors:
            app: auth-service
        mode: one
        action: delay
        delay: 300ms
        percent: "25"
        target: Service
        port: 8080

    - name: auth-error
      templateType: HTTPChaos
      httpChaos:
        selector:
          namespaces:
            - production
          labelSelectors:
            app: auth-service
        mode: one
        action: response
        target: Service
        port: 8080
        percent: "5"
        code: 401
        body: '{"error": "Unauthorized", "message": "Authentication failed"}'

    - name: payment-service-tests
      templateType: Parallel
      deadline: 30m
      children:
        - payment-delay
        - payment-error

    - name: payment-delay
      templateType: HTTPChaos
      httpChaos:
        selector:
          namespaces:
            - production
          labelSelectors:
            app: payment-processor
        mode: one
        action: delay
        delay: 500ms
        percent: "30"
        target: Service
        port: 8080

    - name: payment-error
      templateType: HTTPChaos
      httpChaos:
        selector:
          namespaces:
            - production
          labelSelectors:
            app: payment-processor
        mode: one
        action: abort
        target: Service
        port: 8080
        percent: "5"

    - name: data-service-tests
      templateType: Parallel
      deadline: 30m
      children:
        - data-delay
        - data-error

    - name: data-delay
      templateType: HTTPChaos
      httpChaos:
        selector:
          namespaces:
            - production
          labelSelectors:
            app: postgres-primary
        mode: one
        action: delay
        delay: 200ms
        percent: "20"
        target: Service
        port: 5432

    - name: data-error
      templateType: HTTPChaos
      httpChaos:
        selector:
          namespaces:
            - production
          labelSelectors:
            app: postgres-primary
        mode: one
        action: abort
        target: Service
        port: 5432
        percent: "3"
---
apiVersion: chaos-mesh.org/v1alpha1
kind: Schedule
metadata:
  name: weekly-application-chaos
  namespace: chaos-testing
spec:
  concurrencyPolicy: Forbid
  schedule: "0 3 * * 0"  # Every Sunday at 3 AM
  startingDeadlineSeconds: 7200
  workflows:
    - name: application-resilience-test
    - name: database-failover-test
    - name: cache-failover-test
