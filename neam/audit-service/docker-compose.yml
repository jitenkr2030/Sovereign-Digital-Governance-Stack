version: '3.8'

# ============================================================
# NEAM Platform - Audit, Security & Sovereignty Layer
# Docker Compose Configuration
# ============================================================

services:
  # ============================================================
  # PostgreSQL Database for Audit Logs
  # ============================================================
  audit-postgres:
    image: postgres:15-alpine
    container_name: neam-audit-postgres
    environment:
      POSTGRES_USER: ${AUDIT_DB_USER:-neam_audit}
      POSTGRES_PASSWORD: ${AUDIT_DB_PASSWORD:-audit_secure_password}
      POSTGRES_DB: ${AUDIT_DB_NAME:-neam_audit}
    volumes:
      - audit_postgres_data:/var/lib/postgresql/data
      - ./migrations/001_create_audit_tables.sql:/docker-entrypoint-initdb.d/001_create_audit_tables.sql:ro
    ports:
      - "5432:5432"
    networks:
      - neam_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${AUDIT_DB_USER:-neam_audit} -d ${AUDIT_DB_NAME:-neam_audit}"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes_from:
      - audit-secrets
    command: |
      postgres
      -c max_connections=200
      -c shared_buffers=256MB
      -c effective_cache_size=768MB
      -c work_mem=64MB
      -c maintenance_work_mem=128MB
      -c fsync=on
      -c full_page_writes=on
      -c wal_level=replica
      -c synchronous_commit=on

  # ============================================================
  # OpenSearch for SIEM
  # ============================================================
  opensearch:
    image: opensearchproject/opensearch:2.11.1
    container_name: neam-opensearch
    environment:
      - cluster.name=neam-audit-cluster
      - node.name=node-1
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - discovery.type=single-node
      - DISABLE_INSTALL_DEMO_CONFIG=true
      - DISABLE_SECURITY_PLUGIN=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - opensearch_data:/usr/share/opensearch/data
    ports:
      - "9200:9200"
      - "9600:9600"
    networks:
      - neam_network
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ============================================================
  # Keycloak for Identity Management
  # ============================================================
  keycloak:
    image: quay.io/keycloak/keycloak:22.0
    container_name: neam-keycloak
    command: start-dev
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin_secret}
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-postgres:5432/keycloak
      KC_DB_USERNAME: ${KEYCLOAK_DB_USER:-keycloak}
      KC_DB_PASSWORD: ${KEYCLOAK_DB_PASSWORD:-keycloak_secret}
      KC_HOSTNAME_STRICT: false
      KC_HTTP_ENABLED: true
    depends_on:
      keycloak-postgres:
        condition: service_healthy
    ports:
      - "8080:8080"
    networks:
      - neam_network
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  keycloak-postgres:
    image: postgres:15-alpine
    container_name: neam-keycloak-postgres
    environment:
      POSTGRES_USER: ${KEYCLOAK_DB_USER:-keycloak}
      POSTGRES_PASSWORD: ${KEYCLOAK_DB_PASSWORD:-keycloak_secret}
      POSTGRES_DB: keycloak
    volumes:
      - keycloak_postgres_data:/var/lib/postgresql/data
    networks:
      - neam_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${KEYCLOAK_DB_USER:-keycloak} -d keycloak"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================
  # Audit Service (Main Application)
  # ============================================================
  audit-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: neam-audit-service
    environment:
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - SERVER_PORT=9090
      - DATABASE_URL=postgres://${AUDIT_DB_USER:-neam_audit}:${AUDIT_DB_PASSWORD:-audit_secure_password}@audit-postgres:5432/${AUDIT_DB_NAME:-neam_audit}?sslmode=disable
      - JWT_SECRET=${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      - WORM_STORAGE_PATH=/data/worm
      - HSM_ENABLED=${HSM_ENABLED:-false}
      - KEYCLOAK_ENABLED=${KEYCLOAK_ENABLED:-true}
      - KEYCLOAK_URL=http://keycloak:8080
      - KEYCLOAK_REALM=${KEYCLOAK_REALM:-neam}
      - KEYCLOAK_CLIENT_ID=${KEYCLOAK_CLIENT_ID:-audit-service}
      - KEYCLOAK_CLIENT_SECRET=${KEYCLOAK_CLIENT_SECRET:-audit-service-secret}
      - OPENSEARCH_ENABLED=${OPENSEARCH_ENABLED:-true}
      - OPENSEARCH_URL=http://opensearch:9200
      - OPENSEARCH_INDEX=${OPENSEARCH_INDEX:-neam-audit-logs}
      - MERKLE_SEALING_CRON=${MERKLE_SEALING_CRON:-0 0 * * *}
      - INTEGRITY_CHECK_INTERVAL=${INTEGRITY_CHECK_INTERVAL:-1h}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    volumes:
      - audit_worm_data:/data/worm
      - audit_config:/app/config:ro
    ports:
      - "9090:9090"
    depends_on:
      audit-postgres:
        condition: service_healthy
      opensearch:
        condition: service_healthy
    networks:
      - neam_network
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9090/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ============================================================
  # Prometheus for Metrics
  # ============================================================
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: neam-audit-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - neam_network
    depends_on:
      - audit-service

  # ============================================================
  # Grafana for Visualization
  # ============================================================
  grafana:
    image: grafana/grafana:10.2
    container_name: neam-audit-grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-grafana_secret}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana_data:/var/lib/grafana
    ports:
      - "3000:3000"
    networks:
      - neam_network
    depends_on:
      - prometheus

  # ============================================================
  # WORM Storage (for evidence-grade retention)
  # ============================================================
  worm-storage:
    image: minio/minio:RELEASE.2023-12-20T00-00-00Z
    container_name: neam-worm-storage
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${WORM_ROOT_USER:-worm_admin}
      MINIO_ROOT_PASSWORD: ${WORM_ROOT_PASSWORD:-worm_secret_password}
      MINIO_PROMETHEUS_AUTH_TYPE: public
    volumes:
      - worm_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    networks:
      - neam_network
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9000/minio/health/live || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

# ============================================================
# Networks
# ============================================================
networks:
  neam_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ============================================================
# Volumes
# ============================================================
volumes:
  audit_postgres_data:
    driver: local
  keycloak_postgres_data:
    driver: local
  opensearch_data:
    driver: local
  audit_worm_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
  worm_data:
    driver: local

# ============================================================
# Secrets (for production)
# ============================================================
secrets:
  audit_db_password:
    file: ./secrets/audit_db_password.txt
  jwt_secret:
    file: ./secrets/jwt_secret.txt
  keycloak_client_secret:
    file: ./secrets/keycloak_client_secret.txt
